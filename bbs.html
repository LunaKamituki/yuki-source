<!-- Made by LunaKamituki（神月瑠奈） -->
<style>
  .hiddenElem{
    display: none;
  }
  .red{
    background-color: #e55555;
  }

  .blue{
    background-color: #2fa1ff;
  }


  #tools_menu{
    position: fixed;
    top: 0;
    left: 5px;
    margin-right: 5px;
    margin: 5px;
    padding: 5px;
    background-color: #f5f5f5;
    border-radius: 15px;
    width: 100%;
  }

  #pictureInPicture_display{
    position: fixed;
    bottom: 0;
    right: 0;
    margin: 0px;
    padding: 3px;
    background-color: #fcfcfc;
    border-radius: 15px; 
  }

  #pictureInPicture_display_iframe{
    margin: 0;
  }
  
  #shortcut_help{
    position: fixed;
    bottom: 0;
    left: 0;
    margin: 5px;
    padding: 5px;
    background-color: #cfcfcf;
    border-radius: 15px; 
  }
</style>


<div id="shortcut_help" class="hiddenElem">
  <h3>キーボードショートカットヘルプ</h3>
  
  <table border="1" style="background-color: #efefef;">
    <tr>
      <th>キー</th>
      <th>イベント</th>
    </tr>
    <tr style="display: none;">
      <td>更新待機中...</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + R</td>
      <td>投稿を更新</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + H</td>
      <td>Yuki Youtubeホームへ移動</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + L</td>
      <td>送信</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + N</td>
      <td>ページトップまで移動</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + M</td>
      <td>メッセージ入力状態に変更</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + J</td>
      <td>チャンネルを変更</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + B</td>
      <td>シードを表示/非表示</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + K</td>
      <td>Googleを開く</td>
    </tr>
    <tr>
      <td>rl(⌘,Windows) + Shift + U</td>
      <td>送信にAjaxを使用するかを変更</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + Y</td>
      <td>メニューを開閉</td>
    </tr>
    <tr>
      <td>Ctrl(⌘,Windows) + Shift + /(.)</td>
      <td>ヘルプを表示</td>
    </tr>
  </table>
</div>

<script>
  // utils

  /*function createChildElemFromStr(str) {
    const domParserInstance = new DOMParser()
    return domParserInstance.parseFromString(str, "text/html").body
  }*/

  
  /*function unWrap(elem) {
    if(!elem.hasChildNodes()){return elem}

    for(let i = 0; i < elem.children.length - 1; i++){
      elem.before(elem.children[i], )
    }
    return elem
  }*/
  
 
  function createChildElemFromStr(id, inner_html = ''){
    let div_elem = document.createElement('div');
    div_elem.id = id;
    div_elem.innerHTML = inner_html;
    return div_elem
  }

  function getParam(key){
    const url = new URL(window.location.href);
    return url.searchParams.get(key);
  }

  // 数値文字参照に変換するだけの関数
  function convertToNumericCharacterReference(str){
    const splitted_str = [...str]
    var replaced_str = '';
    for(let i = 0; i < splitted_str.length; i++){
      replaced_str += "&#" + splitted_str[i].codePointAt(0) + ";";
    }
    return replaced_str
  }
    
  // /\s/にmatchする文字を全て数値文字参照に変換するだけの関数
  function replaceBlankCharacters(str){
    if(/\s/.test(str)){
      return str.replace(/(\s)/g, matched => convertToNumericCharacterReference(matched))
    }
    return str
  }
</script>
<script>
  none = '';
  var home_link = document.getElementsByTagName('a')[0];


  // 通常のBBSページの場合のみに限定
  if(home_link.href == location.origin + '/'){
    var formElem = document.getElementsByTagName('form')[0];
    var channelElem = document.getElementById('channel');
    var channel_selectElems = document.getElementsByTagName('option');
    var messageElem = document.getElementsByName('message')[0];
    var nameElem = document.getElementsByName('name')[0];
    var seedElem = document.getElementsByName('seed')[0];
    var verifyElem = document.getElementById('filter');

    formElem.setAttribute('onsubmit', 'return checkForm()');
    channelElem.setAttribute('onchange', 'reloadmessages();setTimeout(function(){update_comments_num();},300);');


    // グローバル変数に
    tools_menu = createChildElemFromStr('<div id="tools_menu" class="hiddenElem"></div>')
    home_link.before(tools_menu);
    
    var tools_menu_button_div = createChildElemFromStr('tools_menu_button_div', `${none}
      <label for="tools_menu_button">
        <button id="tools_menu_button" onclick="tools_menu.removeAttribute(\'class\');">メニューを開く</button>
      </label>`);
    home_link.after(tools_menu_button_div);
    
    // メニューを閉じるボタン
    tools_menu.innerHTML += '<button onclick="tools_menu.setAttribute(\'class\', \'hiddenElem\');">メニューを閉じる</button>'


    pictureInPicture_display = createChildElemFromStr('pictureInPicture_display', `${none}
      <iframe id="pictureInPicture_display_iframe"></iframe>
      <div>
        <input id="pictureInPicture_urlbar" placeholder="URLを入力" value="/watch?v=">
        <button onclick="document.getElementById(\'pictureInPicture_display_iframe\').setAttribute(\'src\', document.getElementById(\'pictureInPicture_urlbar\').value);pictureInPicture_display_iframe.removeAttribute(\'class\');">遷移</button>
      </div>`
    );
    pictureInPicture_display.classList.add('hiddenElem')
    
    document.getElementById('shortcut_help').after(pictureInPicture_display);
    pictureInPicture_display_iframe = document.getElementById('pictureInPicture_display_iframe');
    

    // Ajaxチェックボックス
    tools_menu.appendChild(createChildElemFromStr('ajaxSend_checkbox_div', `${none}
      <label for="ajaxSend_checkbox">Ajaxを使って送信する（リロードなし）
        <input id="ajaxSend_checkbox" type="checkbox">
      </label>`));

    var ajaxSend_checkbox_div = document.getElementById('ajaxSend_checkbox_div');
    var ajaxSend_checkbox = document.getElementById('ajaxSend_checkbox');

    // ピクチャインピクチャチェックボックス
    tools_menu.appendChild(createChildElemFromStr('pictureInPicture_checkbox_div', '<label for="pictureInPicture_checkbox">ピクチャインピクチャ<input id="pictureInPicture_checkbox" type="checkbox"></label>'))
    
    var pictureInPicture_checkbox = document.getElementById('pictureInPicture_checkbox');

    // Ajax機能不利用時にチェックボックスのチェックを外す
    pictureInPicture_checkbox.addEventListener('change', function(e) {
      if(this.checked){
        if(ajaxSend_checkbox.checked) {
          reloadmessages()
        } else {
          this.checked = false;
        }
      } else {
        pictureInPicture_display_iframe.setAttribute('class', 'hiddenElem');
      }
    });

    // キーボードショートカット使用チェックボックス
    tools_menu.appendChild(createChildElemFromStr('keyboardshortcut_checkbox_div', '<label for="keyboardshortcut_checkbox">キーボードショートカットを利用<input id="keyboardshortcut_checkbox" type="checkbox" checked></label>')) 

    var keyboardshortcut_checkbox = document.getElementById('keyboardshortcut_checkbox');

    // ショートカットヘルプ表示非表示ボタン　<= チェックボックスに変更予定
    tools_menu.appendChild(createChildElemFromStr('shortcut_help_button_div', '<button onclick="document.getElementById(\'shortcut_help\').classList.toggle(\'hiddenElem\')">キーボードショートカットヘルプを表示/非表示</button>'))

    // 数値文字参照変換ツール
    tools_menu.appendChild(createChildElemFromStr('add_replace_div', `${none}
      <input id="add_replace_input" placeholder="数値文字参照に変換したい文字列を入力">
      <label for="all_replace_checkbox">
        <input id="all_replace_checkbox" type="checkbox">全て変換
      </label>
      <button id="replace_str" onclick="replace_add_input()">変換してメッセージに追加</button>`
    ))

    var all_replace_checkbox = document.getElementById('all_replace_checkbox');
    var add_replace_input = document.getElementById('add_replace_input');
    
    add_replace_input.addEventListener('keydown', replaceInputKeyPressed);
    

    // 投稿番号表示機能
    var infoElem = document.createElement('div');
    infoElem.id = 'comments_num_info';
    infoElem.textContent = '更新待機中...';
    verifyElem.after(infoElem);
    
    
    

    document.addEventListener('keydown', function(event) {
      if(keyboardshortcut_checkbox.checked){
        if((event.ctrlKey || event.metaKey) && event.shiftKey){
          switch(event.code){
            case 'KeyM':
              event.preventDefault()
              messageElem.focus();
              break
  
            case 'KeyN':
              event.preventDefault()
              window.scroll({
                top: 0,
                behavior: "smooth",
              });
              break
          
            case 'KeyH':
              event.preventDefault()
              location.replace("/");
              break
          
            case 'KeyR':
              event.preventDefault()
              reloadmessages()
              break
        
            case 'KeyL':
              event.preventDefault()
              if(!messageElem.value == '' && checkForm()){
                if(ajaxSend_checkbox.checked){
                  var xhr = new XMLHttpRequest();
                  xhr.open("GET", `/bbs/result?name=${nameElem.value}&seed=${seedElem.value}&channel=${document.getElementById('channel').value}&verify=${verifyElem.checked}&message=${messageElem.value}`);
                  xhr.send();
                  messageElem.value = '';
                  reloadmessages()
                }else{
                  document.getElementsByTagName('form')[0].submit();
                }
              }
              break
          
            case 'KeyJ':
              event.preventDefault()
              channel_selectElems[0].toggleAttribute('selected');
              channel_selectElems[1].toggleAttribute('selected');
              reloadmessages()
          
              setTimeout(function() {
                update_comments_num();
              }, 300);
              break
  
            case 'KeyB':
              event.preventDefault()
              seedElem.classList.toggle('hiddenElem');
              break
  
            case 'KeyK':
              event.preventDefault()
              document.cookie = "yuki=True;max-age=0;";
              location.replace('https://www.google.com/');
              break
  
            case 'KeyU':
              event.preventDefault()
              ajaxSend_checkbox.checked = !ajaxSend_checkbox.checked;
              break
  
            case 'KeyY':
              event.preventDefault()
              if(tools_menu.hasAttribute('class')){
                tools_menu.removeAttribute('class')
              }else{
                tools_menu.setAttribute('class', 'hiddenElem');
              }
              break
            
            case 'Slash':
            case 'Period':
              event.preventDefault()
              document.getElementById('shortcut_help').classList.toggle('hiddenElem');
              break
          }
        
        }
  
      
      }
    });

    
    
    
    update_comments_num(); 
    setTimeout(update_comments_num, 1000);
    setInterval(update_comments_num, 5000);
    
    /*
      var new_title_div_Elem = document.createElement('div');
      new_title_div_Elem.id = 'title_div';
      document.getElementsByTagName('div')[0].after(new_title_div_Elem)
      document.getElementById('title_div').innerHTML = '<input id="title_input" value="連番を簡単に生成！！"><button onclick="document.getElementsByTagName(\'title\')[0].textContent = document.getElementById(\'title_input\').value">titleを変更</button>'
    */
  }
  
  function checkForm(){
    if(messageElem.value.includes(seedElem.value) || messageElem.value.includes(getParam('seed'))){
      console.log('Error: メッセージの中にシードが含まれています。')
      return false
    }else{
      if(ajaxSend_checkbox.checked){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", `/bbs/result?name=${encodeURIComponent(nameElem.value)}&seed=${encodeURIComponent(seedElem.value)}&channel=${document.getElementById('channel').value}&verify=${verifyElem.checked}&message=${encodeURIComponent(messageElem.value)}`);
        xhr.send();
        messageElem.value = '';
        reloadmessages()
        return false
      }else{
        return true
      }
    }
  }

  function update_comments_num(){
    var infoElem = document.getElementById('comments_num_info');
    infoElem.textContent = `現在のコメント数は${comments_num}です。`
    const comments_num = document.getElementsByTagName('td')[0].textContent;
    
    if(comments_num > 9900 && !infoElem.classList.contains('red')){
      infoElem.classList.add('red')
    }else{
      infoElem.classList.remove('red')
    };
  }

  function replace_add_input(){
    var all_replace_checkbox = document.getElementById('all_replace_checkbox');
    const content = add_replace_input.value;
    
    if(all_replace_checkbox.checked){  
      document.getElementsByName('message')[0].value += convertToNumericCharacterReference(content)
    }else{
      document.getElementsByName('message')[0].value += replaceBlankCharacters(content)
    }
  }
  
  function replaceInputKeyPressed(event){
    var all_replace_checkbox = document.getElementById('all_replace_checkbox');
    if(event.key === 'Enter'){
      if(event.shiftKey || event.ctrlKey || event.metaKey){
        all_replace_checkbox.checked = !all_replace_checkbox.checked
      }
      replace_add_input()
    }
  }
    
    
    /*
    function update_nums(){
      const tr_num_elems = document.getElementsByTagName('tr');
      const shHelp_td_num = document.getElementById('shortcut_help').getElementsByTagName('td').lenth;
      
      for(let i = 0; i + shHelp_td_num < tr_num_elems.length; i++){
        if(!i == 0){
          tr_num_elems[i].firstElementChild.setAttribute('onclick', `document.getElementsByName('message')[0].value += ${tr_num_elems[i].firstElementChild.textContent}`)
        }
      }
    }
    */

  function urlConvertToLink(str) {
    var pictureInPicture_checkbox = document.getElementById('pictureInPicture_checkbox');
    if(pictureInPicture_checkbox === null){return 'Error: ピクチャインピクチャチェックボックスが見つかりません。' + str}
      const pattern = /(?:h?ttps?:\/\/[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+|\/(?:watch|search|playlist)\?(?:[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+=[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+&?)+|\/(?:channel|hashtag)\/[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+)/g
      /* これを纏めた
        /((h?)(ttps?:\/\/[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+))/g
          /\/(?:watch|search|playlist)\?(?:[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+=[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+&?)+/g
          /\/(?:channel|hashtag)\/[\w\.\-_@:\/~\?%&;=\+#',\(\)\*\!]+/g
        */
      if(pictureInPicture_checkbox.checked){
        var makeLink = function(matched) {
          return `<a href="javascript:pictureInPicture_display_iframe.setAttribute('src', '${matched}');document.getElementById(\'pictureInPicture_urlbar\').value=\'${matched}\';pictureInPicture_display.removeAttribute('class');">${matched}</a>`;
        }
      }else{
        var makeLink = function(matched) {
          return `<a href="${matched}">${matched}</a>`;
        }
      }
      return '<h2 class="red" style="text-align: center;">修正中</h2>' + str.replace(pattern, makeLink)
  }

  /*const tmp_divs = document.querySelectorAll('createChildElemFromStr-tmp-div');
  tmp_divs.forEach(function(elem) {
    if(elem.hasChildNodes){
      for(let i = 0; i < elem.children.length - 1; i++){
        elem.before(elem.children[i])
      }
      elem.remove()
    }
  });*/
</script>