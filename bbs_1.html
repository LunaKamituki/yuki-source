<!-- Made by LunaKamituki（神月瑠奈） -->
<!-- Yuki BBSに追加するコード1（キーボードショートカット・シード送信防止） -->

<script>
let new_input_elm = document.createElement('div');
new_input_elm.id = 'message_log_div';
new_input_elm.innerHTML = '<input id="message_log" style="display: none;"><button onclick="copy_message_log()">Copy message log</button>（キーボードショートカットで保存し（同時に1つのみ可能）、左のボタンからコピーできる）';
document.getElementsByTagName('div')[0].after(new_input_elm);
  
let formElm = document.getElementsByTagName('form')[0];
let channelElm = document.getElementById('channel')
let channel_selectElms = document.getElementsByTagName('option');
  
let messageElm = document.getElementsByName('message')[0];
let nameElm = document.getElementsByName('name')[0];
let seedElm = document.getElementsByName('seed')[0];
let verifyElm = document.getElementById('filter');
let messageLogElm = document.getElementById('message_log');

  
let new_ajaxSend_checkbox_div = document.createElement('div');
new_ajaxSend_checkbox_div.id = 'ajaxSend_checkbox_div';
new_ajaxSend_checkbox_div.innerHTML = '<label for="new_ajaxSend_checkbox">Ajaxを使って送信する（リロードなし）<input id="new_ajaxSend_checkbox" type="checkbox"></label>'

document.getElementsByTagName('div')[0].after(new_ajaxSend_checkbox_div)

let ajaxSend_checkbox = document.getElementById('new_ajaxSend_checkbox');

document.addEventListener('keydown', function(event) {
  if((event.ctrlKey || event.metaKey) && event.shiftKey){
    
    console.log(event.code);
    
    switch(event.code){
      case 'KeyM':
        event.preventDefault()
        messageElm.focus();
        break

      case 'KeyN':
        event.preventDefault()
        window.scroll({
          top: 0,
          behavior: "smooth",
        });
        break
        
      case 'KeyH':
        event.preventDefault()
        location.replace("/");
        break
        
      case 'KeyR':
        event.preventDefault()
        reloadmessages()
        break
      
      case 'KeyL':
        event.preventDefault()
        if(!messageElm.value == '' && checkForm()){
          if(ajaxSend_checkbox.checked){
            let xhr = new XMLHttpRequest();
            xhr.open("GET", `/bbs/result?name=${nameElm.value}&seed=${seedElm.value}&channel=${channelElm.value}&verify=${verifyElm.checked}&message=${messageElm.value}`);
            xhr.send();
            messageElm.value = '';
            reloadmessaes()
          }else{
            formElm.submit();
          }
        }
        break
        
      case 'KeyJ':
        event.preventDefault()
        channel_selectElms[0].toggleAttribute('selected');
        channel_selectElms[1].toggleAttribute('selected');
        reloadmessages()
        
        setTimeout(function() {
          update_comments_num();
        }, 300);
        break

      case 'KeyB':
        event.preventDefault()
        seedElm.classList.toggle('hiddenElm');
        break

      case 'KeyK':
        event.preventDefault()
        document.cookie = "yuki=True;max-age=0;";
        location.replace('https://www.google.com/');
        break

      case 'KeyI':
        event.prentDefault()
        ajaxSend_checkbox.checked = !ajaxSend_checkbox.checked;
        break
        
      case 'KeyG':
        event.preventDefault()
        var messages_log = document.getElementById('messages').innerHTML;
        messageLogElm.value = messages_log.toString();
        console.log(messages_log);
        break
        
      case 'Slash':
      case 'Period':
        event.preventDefault()
        document.getElementById('shortcut_help').classList.toggle('hiddenElm');
        break
    }
  }
});

document.getElementsByTagName('form')[0].setAttribute('onsubmit', 'return checkForm()')

function getParam(key){
  let url = new URL(window.location.href);
  return url.searchParams.get(key);
}
  
function checkForm(){
  const message = document.getElementsByName('message')[0].value
  if(message.includes(document.getElementsByName('seed')[0].value) || message.includes(getParam('seed'))){
    console.log('Error: メッセージの中にシードが含まれています。')
    return false
  }else{
    if(ajaxSend_checkbox.checked){
      let xhr = new XMLHttpRequest();
      xhr.open("GET", `/bbs/result?name=${nameElm.value}&seed=${seedElm.value}&channel=${channelElm.value}&verify=${verifyElm.checked}&message=${messageElm.value}`);
      xhr.send();
      messageElm.value = '';
      reloadmessages()
      return false
    }else{
      return true
    }
  }
}

function copy_message_log(){
  
  if(!navigator.clipboard){
    alert("Error: コピー出来ません。ブラウザが対応していない可能性があります。");
    return
  }
  
  const content = document.getElementById('message_log').value;
  
  if(content == ''){
    alert('ログがありません。')
    return
  }
  
  navigator.clipboard.writeText(content).then(
    () => {
      alert('コピーしました。');
    },
    () => {
      alert('コピーに失敗しました。');
    });
  
}


</script>
