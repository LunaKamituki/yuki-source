<!-- Made by LunaKamituki（神月瑠奈） -->
<!-- Yuki BBSに追加するコード1（キーボードショートカット・シード送信防止） -->

<script>
let new_input_elm = document.createElement('div');
new_input_elm.id = 'message_log_div';
new_input_elm.innerHTML = '<input id="message_log" style="display: none;"><button onclick="copy_message_log()">Copy message log</button>（キーボードショートカットで保存し（同時に1つのみ可能）、左のボタンからコピーできる）';
document.getElementsByTagName('div')[0].after(new_input_elm);;
  
let formElm = document.getElementsByTagName('form')[0];
let messageElm = document.getElementsByName('message')[0];
let channelElms = document.getElementsByTagName('option');
let seedElm = document.getElementsByName('seed')[0];
let messageLogElm = document.getElementById('message_log');

document.addEventListener('keydown', function(event) {
  if((event.ctrlKey || event.metaKey) && event.shiftKey){
    
    console.log(event.code);
    
    switch(event.code){
      case 'KeyM':
        event.preventDefault()
        messageElm.focus();
        break

      case 'KeyN':
        event.preventDefault()
        window.scroll({
          top: 0,
          behavior: "smooth",
        });
        break
        
      case 'KeyH':
        event.preventDefault()
        location.replace("/");
        break
        
      case 'KeyR':
        event.preventDefault()
        reloadmessages()
        // location.replace(location.href);
        break
      
      case 'KeyL':
        event.preventDefault()
        if(!(messageElm.value == '')){
          formElm.submit();
        }
        break
        
      case 'KeyJ':
        event.preventDefault()
        channelElms[0].toggleAttribute('selected');
        channelElms[1].toggleAttribute('selected');
        reloadmessages()
        
        setTimeout(function() {
          update_comments_num();
        }, 300);
        break

      case 'KeyB':
        event.preventDefault()
        seedElm.classList.toggle('hiddenElm');
        break

      case 'KeyK':
        event.preventDefault()
        document.cookie = "yuki=True;Max-Age:0;";
        window.open('https://www.google.com/', '_self');
        break

      case 'KeyG':
        event.preventDefault()
        var messages_log = document.getElementById('messages').innerHTML;
        messageLogElm.value = messages_log.toString();
        console.log(messages_log);
        break
        
      // 端末によっては、Slashの場合既存のキーボードショートカットと重複するのでPeriodを追加した。
      case 'Slash':
      case 'Period':
        event.preventDefault()
        document.getElementById('shortcut_help').classList.toggle('hiddenElm');
        break
    }
  }
});

document.getElementsByTagName('form')[0].setAttribute('onsubmit', 'return checkForm()')
  
function checkForm(){
  if(document.getElementsByName('message')[0].value.includes(document.getElementsByName('seed')[0].value)){
    console.log('error: メッセージの中にシードが含まれています。')
    return false
  }else{
    console.log('confilm')
    return true
  }
}

function copy_message_log(){
  
  if(!navigator.clipboard){
    alert("Error: コピー出来ません。ブラウザが対応していない可能性があります。");
    return
  }
  
  const content = document.getElementById('message_log').value;
  
  if(content == ''){
    alert('ログがありません。')
    return
  }
  
  navigator.clipboard.writeText(content).then(
    () => {
      alert('コピーしました。');
    },
    () => {
      alert('コピーに失敗しました。');
    });
  
}
</script>
